---
title: "Analysis"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# An analysis using LiDAR data to detect moose browsing effects, with ground truthing

```{r}
library(readr)
library(ggplot2)
library(glmmTMB)
```

## Get compiled dataset (see compile.R)


```{r}
dat <- read_csv("../data/compiledDataset.csv")
head(dat)
```


## A quick data check
```{r}
table(dat$Treatment, dat$Clear.cut)
```

```{r}
table(dat$Year.initiated, dat$LiDAR.data.from.year)
```

```{r}
table(dat$plot_density_m2, dat$resolution_m)
```
Something odd there...

```{r}
table(dat$region, dat$Treatment)
```

```{r}
table(dat$LocalityName, dat$Treatment)
```
Looks good.


## Canopy growth per year
Lets first compute canopy growth per year since exclosure
```{r}
dat$canopygrowth <- dat$md/dat$YrsSinceExclosure
summary(dat$canopygrowth)
```
The numbers are in meters I'm pretty sure

One of the first things to decide on is what to do with productivity, as there are two outliers:
```{r}
plot(dat$prod, ylab="Productivity")
```
```{r}
dat[dat$prod>0.6,c("LocalityName", "region", "prod")]
```
These are two sites in Hedmark that probably really are very productive, although there could have been serious sampling error due to chance. But they are legitimate, and we should be careful not to drop them too willingly. 


```{r}
dat$Treatment <- as.factor(dat$Treatment)
levels(dat$Treatment) <- c('Open plot','Exclosure')
dat$outlier <- "no"
dat$outlier[dat$LocalityName == "Nes 2" | dat$LocalityName == "Stig Dahlen"] <- "yes"
(spag1 <- 
    ggplot(dat, aes(x=Treatment, y=canopygrowth, group=LocalityName, linetype = outlier))+
  geom_line()+
  labs(y=expression(paste('Canopy height growth (m year'^'-1', ')')), x='Treatment')+
  scale_linetype_manual(breaks = c("Exclosure", "Open plot"), 
                        labels = c("Open plots", "Exclosures"), values=c(1,2))+
  scale_x_discrete(limits = c('Open plot', 'Exclosure'), 
                   breaks = c('Open plot', 'Exclosure'), expand = c(0.1,0))+
  theme_bw()+
  theme(text = element_text(size = 20))+
  ylim(0, 0.45)
)
```
The two 'outlier sites' are in dotted lines.

Now lets plot the interaction between productivity and treatment.
We can use the log of the productivity if residuals are acting strange.
Lets use a loess smoother for this as it makes less assumptions about the shape of the relationship:
```{r}
ggplot(data = dat,
                    aes(x = prod, y = canopygrowth))+
  geom_point(aes(colour= Treatment, shape=region))+
   geom_smooth(aes(colour= Treatment),
               method = "loess", formula =  'y ~ x')+
  labs(y=expression(paste('Canopy height growth (m year'^'-1', ')')), x='Productivity')+
  theme_bw()+
  scale_color_manual(values = c("gray0", "gray60"))+
  labs(colour="Treatment", shape="Region")+
  theme(text = element_text(size = 20))+
  #ylim(0, 0.4)+
  theme(legend.position = 'right',
                             legend.justification = c("left", "top"),
                             legend.box.just = "left",
                             #legend.margin = margin(5, 5, 5, 5),
                             legend.text = element_text(size=12))

```
The highly productive sites are affecting this picture quite a bit I'd imagine. Let's try with a log-transformation:
```{r}
dat$prod_l <- log(dat$prod+1)
ggplot(data = dat,
                    aes(x = prod_l, y = canopygrowth))+
  geom_point(aes(colour= Treatment, shape=region))+
   geom_smooth(aes(colour= Treatment),
               method = "loess", formula =  'y ~ x')+
  labs(y=expression(paste('Canopy height growth (m year'^'-1', ')')), x='log(Productivity)')+
  theme_bw()+
  scale_color_manual(values = c("gray0", "gray60"))+
  labs(colour="Treatment", shape="Region")+
  theme(text = element_text(size = 20))+
  #ylim(0, 0.4)+
  theme(legend.position = 'right',
                             legend.justification = c("left", "top"),
                             legend.box.just = "left",
                             #legend.margin = margin(5, 5, 5, 5),
                             legend.text = element_text(size=12))

```
That's perhaps a little better. 
There's a relationship there it seems like, but perhaps not linear. Also note that all the really productive sites are in Hedmark:

```{r}
table(round(dat$prod, 1), dat$region)
```

```{r}
boxplot(dat$prod_l~dat$region)
```
Lets investigate the effect of region a bit more.
```{r}
ggplot(data = dat,
  aes(x = prod_l, y = canopygrowth, colour = region))+
  geom_point()+
  geom_smooth(method = "lm")+
  labs(y=expression(paste('Canopy height growth (m year'^'-1', ')')), x='log(Productivity)')+
  theme_bw()+
  #scale_color_manual(values = c("gray0", "gray50", "grey100"))+
  labs(colour="Region")+
  theme(text = element_text(size = 12))+
  #ylim(0, 0.4)+
  theme(legend.position = 'right',
                             legend.justification = c("left", "top"),
                             legend.box.just = "left",
                             #legend.margin = margin(5, 5, 5, 5),
                             legend.text = element_text(size=12))

```
This plot tells us there is no need for a random slope model. Also, the two productivity outliers appear less like outliers when only looking at the Hedmark data points.

### Summary stats (OBS, don't report these - keep reading)
Let's get some summary stats. 
```{r}
m <- tapply(dat$canopygrowth, dat$Treatment, FUN = mean)
# And standard error:
source('se.R')
s <- tapply(dat$canopygrowth, dat$Treatment, FUN = se)
(cg_means <- data.frame("mean canopy growth per year" = round(m, 3),
                        "standard error of the mean" = round(s, 3)))
```
```{r}
rm(m, s)
```


We need a model to describe the interaction between treatment and productivity. The response is continous and both positive and negative values can occur, so a gaussian familiy would be appropriate.
```{r}
library(glmmTMB) # using this package even though I dont need all its finesse...
dat$region <- as.factor(dat$region)
mod1 <- glmmTMB(canopygrowth ~ Treatment * prod_l + (1|region),
  data = dat,  family = gaussian)
```

```{r}
mod2 <- glmmTMB(canopygrowth ~ Treatment * prod_l ,
  data = dat,  family = gaussian)

```

```{r}
AIC(mod1, mod2)
```
Model 2 is slightly better, suggesting we drop the random intercept.
What does ANOVA say about this?
```{r}
anova(mod1, mod2)
```
The models explain exactly the same, so we can drop the random intercept. The only reason for keeping it is if we want to argue it's part of the design, which it is. However, I don't think that's more important than having a parsimoinous model. 


```{r}
summary(mod2)
```
Significant interaction term, so we're keeping this full model.
We can also see what the random effect would've give us:
```{r}
ranef(mod1)
```
, and it's not very much.

```{r}
plot(resid(mod2), fitted(mod2))
```

```{r}
par(mfrow=c(2,2))
qqnorm(resid(mod2))
plot(resid(mod2)~ dat$region)
plot(resid(mod2), dat$prod)
plot(resid(mod2)~ dat$Treatment)

```
Looks like everything is in order. The residuals agains productivity at least sho a centering around zero.


```{r}
ggplot(data = dat,
                    aes(x = prod, y = canopygrowth, colour= Treatment))+
  geom_point()+
   geom_smooth(method = "lm")+
  labs(y=expression(paste('Canopy height growth (m year'^'-1', ')')), x='log(Productivity)')+
  theme_bw()+
  scale_color_manual(values = c("gray0", "gray60"))+
  labs(colour="Treatment")+
  theme(text = element_text(size = 12))+
  #ylim(0, 0.4)+
  theme(legend.position = 'right',
                             legend.justification = c("left", "top"),
                             legend.box.just = "left",
                             #legend.margin = margin(5, 5, 5, 5),
                             legend.text = element_text(size=12))
```
So here we're modelling a linear function of productivity. We could try adding a quadratic term. 

```{r}
dat$prod_l2 <- dat$prod_l*dat$prod_l
mod3 <- glmmTMB(canopygrowth ~ Treatment * prod_l + prod_l2,
  data = dat,  family = gaussian)
```

```{r}
AIC(mod2, mod3)
```
This gave a slight improvement.
```{r}
anova(mod2, mod3)
```
The numbers tell us we should keep it. We will need to remake that plot above, but we'll get to that.


## Sensitivity analysis
We should do a sensitivity analysis by removing the outliers and comparing the results that those models give us.
```{r}
dat2 <- dat[dat$prod <0.7,]
dim(dat2)
```
That deleted the two most productive sites.
```{r}
mod_sens1 <- glmmTMB(canopygrowth ~ Treatment * prod + (1|region),
  data = dat2,  family = gaussian)
mod_sens2 <- glmmTMB(canopygrowth ~ Treatment * prod,
  data = dat2,  family = gaussian)
mod_sens3 <- glmmTMB(canopygrowth ~ Treatment * prod + I(prod^2),
  data = dat2,  family = gaussian)
cg_cand <- data.frame(AIC(mod_sens1, mod_sens2, mod_sens3))
cg_cand$model <- c("Intial model: Treatment * prod + (1|region)",
                   "-(1|region)",
                   "-(1|region) and + prodÂ²")
cg_cand
```

```{r}
summary(mod_sens2)
```
The results are qualitatively the same, which justified keeping the 'outliers' in. (but see discussing below at the end of the MAD chaper)

## Plot
```{r}
tr <- rep(c("Open plot", "Exclosure"), times=50, each=1)
prod_l <- seq(from = min(dat$prod_l), to=max(dat$prod_l), length.out = 100)
prod_l2 <- prod_l^2

pred <- predict(mod3, list(Treatment= tr, 
                           prod_l   = prod_l, 
                           prod_l2  = prod_l2), 
                           se.fit   = TRUE)
pred2 <- data.frame(Treatment = tr,
                    prod_l    = prod_l,
                    pred      = pred$fit,
                    se        = pred$se.fit)
```

```{r}
(cg_wOutlier <- 
  ggplot()+
  geom_point(data = dat,aes(x = exp(prod_l)-1, y = canopygrowth, colour= Treatment))+
  geom_line(data=pred2, aes(x = exp(prod_l)-1, y=pred, colour = Treatment))+
  geom_ribbon(data=pred2, aes(x = exp(prod_l)-1, 
                              ymin=pred-se, 
                              ymax=pred+se, 
                              group = Treatment),
                              alpha=0.2,
                              linetype="blank")+
  labs(y=expression(paste('Canopy height growth (m year'^'-1', ')')), x='Productivity')+
  theme_bw()+
  scale_color_manual(values = c("gray80", "black"))+
  labs(colour="Treatment")+
  theme(text = element_text(size = 12))+
  theme(legend.position = 'right',
                             legend.justification = c("left", "top"),
                             legend.box.just = "left",
                             #legend.margin = margin(5, 5, 5, 5),
                             legend.text = element_text(size=12))
)
```
```{r}
rm(tr, prod_l, prod_l2, pred, pred2)
```
I have backtransformed the productivity axis in this plot. The ribbons are +-SE, but perhaps 95%CIs are better, or +-1.96SE.

We can also make these nice violin plots, even though the main pot should show the interaction effect like the plot above does.
```{r}
(cg_viol <- 
   ggplot(data = dat2, aes(x = Treatment, y = canopygrowth))+
  geom_violin(fill = "grey")+
  theme_bw()+
  theme(text = element_text(size = 12))+
  labs(y=expression(paste('Canopy height growth (m year'^'-1', ')')), x='')+
  stat_summary(fun.y=mean, geom="point", shape=23, size=2)
)
```

## MAD
I think first and foremost it's the relative MAD we should focus on. That's the equivalent of CV (Coefficient of Variation).
```{r}
dat$rMAD <- dat$mad/dat$md
summary(dat$rMAD)
```
Looks sqewed.
```{r}
par(mfrow=c(1,2))
plot(dat$mad)
plot(dat$md)
```
The two factors are well-behaved at first glance. 
```{r}
plot(dat$rMAD)
```
But this one is not.
```{r}
dat[dat$rMAD>4, c("LocalityName", "Treatment", "md", "mn", "sd", "mad", "rMAD")]
```
It's the median that is causing trubble. It's very low, 0.004m.
```{r}
library(reshape2)
myMelt <- melt(data = dat, id.vars = "LocalityCode", measure.vars = c("mad", "mn"))
ggplot(myMelt, aes(x=variable, y=value, group=LocalityCode))+
  geom_line()+
  labs(y='...', x='Variable')+
  theme_bw()+
  theme(text = element_text(size = 20))
```
This doesn't look strange. 
Is is simply the low median value that increases rMAD asymptotically. It's of coarse the lowers median in the data set, as you can see here:
```{r}
min(dat$md)
```
Lets remake rMAD with a slight moderation:
```{r}
dat$rMAD2 <- dat$mad/(dat$mn+1)
par(mfrow=c(1,2))
plot(dat$rMAD2, main = "new")
plot(dat$rMAD, main = "old")
```
I don't see how this can affect the interpretation of rMAD. Let's use it.


```{r}
(spag2 <- 
   ggplot(dat, aes(x=Treatment, y=rMAD2, group=LocalityName, linetype = outlier))+
  geom_line()+
  labs(y='Relative Median Abs. Deviation', x='Treatment')+
  scale_linetype_manual(breaks = c("Exclosure", "Open plot"), 
                        labels = c("Open plots", "Exclosures"), values=c(1,2))+
  scale_x_discrete(limits = c('Open plot', 'Exclosure'), 
                   breaks = c('Open plot', 'Exclosure'), expand = c(0.1,0))+
  theme_bw()+
  theme(text = element_text(size = 20))
)
```
```{r}
ggplot(data = dat,
                    aes(x = prod, y = rMAD2))+
  geom_point(aes(colour= Treatment, shape=region))+
   geom_smooth(aes(colour= Treatment),
               method = "loess", formula =  'y ~ x')+
  labs(y='Relative Median Abs. Deviation', x='log(Productivity)')+
  theme_bw()+
  scale_color_manual(values = c("gray80", "black"))+
  labs(colour="Treatment", shape="Region")+
  theme(text = element_text(size = 20))+
  #ylim(0, 0.4)+
  theme(legend.position = 'right',
                             legend.justification = c("left", "top"),
                             legend.box.just = "left",
                             #legend.margin = margin(5, 5, 5, 5),
                             legend.text = element_text(size=12))

```
Prorbably no interaction with productivity here, but the 'exclosure line' appear to lie higher.
Let's see if there an effect of region
```{r}
ggplot(data = dat,
                    aes(x = prod, y = rMAD2))+
  geom_point(aes(colour=region, shape=Treatment))+
   geom_smooth(aes(colour= region),
               method = "lm", formula =  'y ~ x')+
  labs(y='Relative Median Abs. Deviation', x='log(Productivity)')+
  theme_bw()+
  #scale_color_manual(values = c("gray80", "black", "grey20"))+
  labs(colour="Region", shape="Treatment")+
  theme(text = element_text(size = 20))+
  #ylim(0, 0.4)+
  theme(legend.position = 'right',
                             legend.justification = c("left", "top"),
                             legend.box.just = "left",
                             #legend.margin = margin(5, 5, 5, 5),
                             legend.text = element_text(size=12))

```
Looks like we might need a random slope for this one.

```{r}
modmad <- glmmTMB(data = dat,
                  rMAD2~Treatment*prod_l+prod_l2+(prod_l|region),
                  family = gaussian)
summary(modmad)
```
Note perfect correlation between random effect. All I can think of trying the centering.
```{r}
dat$prod_lc <- dat$prod_l-mean(dat$prod_l)
dat$prod_l2c <- dat$prod_l2-mean(dat$prod_l2)
par(mfrow=c(2,2))
hist(dat$prod_l, xlim = c(-0.7,0.7))
hist(dat$prod_lc, xlim = c(-0.7,0.7))
hist(dat$prod_l2, xlim = c(-0.7,0.7))
hist(dat$prod_l2c, xlim = c(-0.7,0.7))

```
Ok, but notice how sqewed the quadratic term is, probably amplifying the 'outlierissue'...
```{r}
modmad2 <- glmmTMB(data = dat,
                  rMAD2~Treatment*prod_lc+prod_l2c+(prod_lc|region),
                  family = gaussian)
summary(modmad2)
```
Well that just made it worse. I think we just need to simplyfy the model.
```{r}
modmad3 <- glmmTMB(data = dat,
                  rMAD2~Treatment*prod_l+prod_l2+(1|region),
                  family = gaussian)
summary(modmad3)
```
Like so. Lets for fun compare with the random slope model, but I'm not sure if its AIC is compareable/reliable:
```{r}
AIC(modmad, modmad3)
```
The random intecept model is better anyways.
Byt we can drop the interaction, and theat leave us with:
```{r}
modmad4 <- update(modmad3, .~. -Treatment:prod_l)
summary(modmad4)
```
All very significant. Error estimates seem reasonable. Let's look at some validation plots.
```{r}
par(mfrow = c(2,2))
plot(resid(modmad4), fitted(modmad4))
plot(dat$prod_l, resid(modmad4))
plot(dat$prod_l2, resid(modmad4))
plot(resid(modmad4)~dat$Treatment)
```
Looks fine. 

## Plot rMAD2
```{r}
tr <- rep(c("Open plot", "Exclosure"), times=50, each=1)
prod_l <- seq(from = min(dat$prod_l), to=max(dat$prod_l), length.out = 100)
prod_l2 <- prod_l^2
region <- rep(NA, times=100)

pred <- predict(modmad4, list(Treatment=tr, 
                              prod_l=prod_l, 
                              prod_l2=prod_l2,
                              region = region), se.fit = TRUE)
pred2 <- data.frame(Treatment = tr,
                    prod_l    = prod_l,
                    pred      = pred$fit,
                    se        = pred$se.fit)
```

```{r}
(rmad_wOutlier <- 
  ggplot()+
  geom_point(data = dat,aes(x = exp(prod_l)-1, y = rMAD2, colour= Treatment))+
  geom_line(data=pred2, aes(x = exp(prod_l)-1, y=pred, colour = Treatment))+
  geom_ribbon(data=pred2, aes(x = exp(prod_l)-1, 
                              ymin=pred-se, 
                              ymax=pred+se, 
                              group = Treatment),
                              alpha=0.2,
                              linetype="blank")+
  labs(y="Relative Median Abs. Deviation", x='Productivity')+
  theme_bw()+
  scale_color_manual(values = c("gray80", "black"))+
  labs(colour="Treatment")+
  theme(text = element_text(size = 12))+
  theme(legend.position = 'right',
                             legend.justification = c("left", "top"),
                             legend.box.just = "left",
                             #legend.margin = margin(5, 5, 5, 5),
                             legend.text = element_text(size=12))
)
```

That looks a bit odd. Lets look at it without backtransforming the x-axis:
```{r}
ggplot()+
  geom_point(data = dat,aes(x = prod_l, y = rMAD2, colour= Treatment))+
  geom_line(data=pred2, aes(x = prod_l, y=pred, colour = Treatment))+
  geom_ribbon(data=pred2, aes(x = prod_l, 
                              ymin=pred-se, 
                              ymax=pred+se, 
                              group = Treatment),
                              alpha=0.2,
                              linetype="blank")+
  labs(y="Relative Median Abs. Deviation", x='log(Productivity)')+
  theme_bw()+
  scale_color_manual(values = c("gray80", "black"))+
  labs(colour="Treatment")+
  theme(text = element_text(size = 12))+
  theme(legend.position = 'right',
                             legend.justification = c("left", "top"),
                             legend.box.just = "left",
                             #legend.margin = margin(5, 5, 5, 5),
                             legend.text = element_text(size=12))
```
```{r}
rm(tr, prod_l, prod_l2, region, pred, pred2)
```
Still strange. 


## Sensitivity analysis
Removing the most productive sites and comparing the results
```{r}
dat2 <- dat[dat$prod<0.7,]
dat2$prod2 <- dat2$prod^2
```
```{r}
mads <- glmmTMB(data=dat2,
                rMAD2~Treatment*prod+prod2+(1|region), family = gaussian)
mads2 <- update(mads, .~. -prod2)
mads3 <- update(mads2, .~. -Treatment:prod)
mads4 <- update(mads, .~. -Treatment:prod)

rmad_cand <- data.frame(AIC(mads, mads2, mads3, mads4))
rmad_cand$model <- c("Global model: Treatment*prod+prod2+(1|region)",
                     "-prod2",
                     "-Treatment:prod and -prod2",
                     "-Treatment:prod")
rmad_cand
```
The interaction term is dropped when not including the most productive sites.
```{r}
tr <- rep(c("Open plot", "Exclosure"), times=50, each=1)
prod <- seq(from = min(dat2$prod), to=max(dat2$prod), length.out = 100)
prod2 <- prod^2
region <- rep(NA, times=100)
pred <- predict(mads4, list(Treatment=tr, 
                              prod   =prod,
                              prod2  =prod2,
                              region =region), se.fit = TRUE)
pred2 <- data.frame(Treatment = tr,
                    prod      = prod,
                    pred      = pred$fit,
                    se        = pred$se.fit)
```

```{r}
(rmad <- 
   ggplot()+
  geom_point(data = dat2,aes(x = prod, y = rMAD2, colour= Treatment))+
  geom_line(data=pred2, aes(x = prod, y=pred, colour = Treatment))+
  geom_ribbon(data=pred2, aes(x = prod, 
                              ymin=pred-se, 
                              ymax=pred+se, 
                              group = Treatment),
                              alpha=0.2,
                              linetype="blank")+
  labs(y="Relative Median Abs. Deviation", x='Productivity')+
  theme_bw()+
  scale_color_manual(values = c("gray80", "black"))+
  labs(colour="Treatment")+
  theme(text = element_text(size = 12))+
  theme(legend.position = 'right',
                             legend.justification = c("left", "top"),
                             legend.box.just = "left",
                             #legend.margin = margin(5, 5, 5, 5),
                             legend.text = element_text(size=12))
)
```
```{r}
rm(tr, prod, prod2, region, pred, pred2)
```

The plots are very different looking, but from 0 - 0.5 the lines follow a quite similar path. Probably this last one is more logical, as there no reason to think that rMAD should go towards zero as prod increases. It's however a little confusing for the reader if we sometimes take the points out and sometimes not... That makes me opt for removing them from the start. We can include the plots as appendix as a safeguard perhaps.

Lets validata that last model.

```{r}
par(mfrow=c(2,2))
plot(resid(mads4), fitted(mads4))
plot(dat2$prod, resid(mads4))
plot(dat2$prod2, resid(mads4))
plot(resid(mads4)~dat2$Treatment)
```
ok. 
```{r}
summary(mads4)
```
So the interaction isn't significant, but lowers the AIC none the less.
Summary stats:
```{r}
m <- tapply(dat2$rMAD2, dat2$Treatment, FUN = mean)
# And standard error:
source('se.R')
s <- tapply(dat2$rMAD2, dat2$Treatment, FUN = se)
(rmad_means <- data.frame("mean canopy growth per year" = round(m, 3),
                        "standard error of the mean" = round(s, 3)))
```

## Canopy growth v2
Because we decided to drop the 'outliers', we want to da that also in the canopy growth analysis.
We have the model:
```{r}
summary(mod_sens2)
```
Significant interaction, ok.
Some validation.
```{r}
par(mfrow = c(2,2))
plot(resid(mod_sens2), fitted(mod_sens2))
plot(dat2$prod, resid(mod_sens2))
plot(resid(mod_sens2)~dat2$Treatment)
```
Ok. And some new summary stats:
```{r}
m <- tapply(dat2$canopygrowth, dat2$Treatment, FUN = mean)
s <- tapply(dat2$canopygrowth, dat2$Treatment, FUN = se)
data.frame("mean canopy growth per year in meters" = round(m, 3),
                        "standard error of the mean" = round(s, 3))
```
And plot
```{r}
tr <- rep(c("Open plot", "Exclosure"), times=50, each=1)
prod <- seq(from = min(dat2$prod), to=max(dat2$prod), length.out = 100)
pred <- predict(mod_sens2, list(Treatment= tr, 
                           prod   = prod), 
                           se.fit   = TRUE)
pred2 <- data.frame(Treatment = tr,
                    prod      = prod,
                    pred      = pred$fit,
                    se        = pred$se.fit)
```

```{r}
(cg <- 
  ggplot()+
  geom_point(data = dat2,aes(x = prod, y = canopygrowth, colour= Treatment))+
  geom_line(data=pred2, aes(x = prod, y=pred, colour = Treatment))+
  geom_ribbon(data=pred2, aes(x = prod, 
                              ymin=pred-se, 
                              ymax=pred+se, 
                              group = Treatment),
                              alpha=0.2,
                              linetype="blank")+
  labs(y=expression(paste('Canopy height growth (m year'^'-1', ')')), x='Productivity')+
  theme_bw()+
  scale_color_manual(values = c("gray80", "black"))+
  labs(colour="Treatment")+
  theme(text = element_text(size = 12))+
  theme(legend.position = 'right',
                             legend.justification = c("left", "top"),
                             legend.box.just = "left",
                             #legend.margin = margin(5, 5, 5, 5),
                             legend.text = element_text(size=12))
)
```
```{r}
rm(tr, prod, pred, pred2)
```

## Compare LiDAR and field data
First, let's calculate canopy growth as we did for the LiDAR data

```{r}
dat2$canopygrowth_f <- dat2$field_median/dat2$YrsSinceExclosure
```

```{r}
summary(dat2$canopygrowth_f)
```

```{r}
par(mfrow=c(2,2), mar=c(4,4,1,1))
plot(dat2$canopygrowth_f, ylab="Median")
plot(dat2$canopygrowth_f~dat2$Treatment, xlab="", ylab="Median")
plot(dat2$canopygrowth_f~dat2$prod, xlab="Productivity", ylab="Median")
plot(dat2$canopygrowth_f~dat2$region, xlab="", ylab="Median")
```
Appears the annual median tree growth of a site (median of the median of a circle) is around 0.1, or precisely:
```{r}
median(dat2$canopygrowth_f)
```
Also, it is greater in exclosures and increases with productivity, and is highest in Hedmark. Very similar to the LiDAR data.
```{r}
m2 <- tapply(dat2$canopygrowth_f, dat2$Treatment, FUN = mean)
s2 <- tapply(dat2$canopygrowth_f, dat2$Treatment, FUN = se)
(cg_field <- data.frame("mean canopy growth per year" = round(m2, 3),
                        "standard error of the mean" = round(s2, 3)))
```

We don't want to analyse the field data alone, or by itself. That we have done in other papers and with more data. Here we are only interested in 'ground-truthing' the LiDAR data. So..:

```{r}
ggplot(data = dat2,
                    aes(x = canopygrowth, y = canopygrowth_f, colour= Treatment))+
  geom_point()+
   geom_smooth(method = "lm")+
  labs(y=expression(paste('Field-based canopy height growth (m year'^'-1', ')')), x=expression(paste('LiDAR-based canopy height growth (m year'^'-1', ')')))+
  theme_bw()+
  scale_color_manual(values = c("gray0", "gray60"))+
  labs(colour="Treatment")+
  theme(text = element_text(size = 12))+
  ylim(0, 0.4)+
  theme(legend.position = 'right',
                             legend.justification = c("left", "top"),
                             legend.box.just = "left",
                             #legend.margin = margin(5, 5, 5, 5),
                             legend.text = element_text(size=12))+
   geom_abline(intercept = 0, slope = 1, color="red", 
                 linetype="dashed", size=1.5)

```
Perhaps the correation strength differes between treatment, but not very much.

```{r}
ggplot(data = dat2,
                    aes(x = canopygrowth, y = canopygrowth_f, colour= region))+
  geom_point()+
   geom_smooth(method = "lm")+
  labs(y=expression(paste('Field-based canopy height growth (m year'^'-1', ')')), x=expression(paste('LiDAR-based canopy height growth (m year'^'-1', ')')))+
  theme_bw()+
  
  labs(colour="Region")+
  theme(text = element_text(size = 12))+
  ylim(0, 0.4)+
  theme(legend.position = 'right',
                             legend.justification = c("left", "top"),
                             legend.box.just = "left",
                             #legend.margin = margin(5, 5, 5, 5),
                             legend.text = element_text(size=12))+
   geom_abline(intercept = 0, slope = 1, color="red", 
                 linetype="dashed", size=1.5)

```
Also it differs a bit between region. 

Also, we can look at the effect that experimental duration has had on the correlation:
```{r}
dat2$diff <- dat2$canopygrowth-dat2$canopygrowth_f
hist(dat2$diff)
```

```{r}
ggplot(data = dat2,
        aes(x = YrsSinceExclosure, y = diff))+
  geom_point()+
  geom_smooth(method = "lm")+
  labs(y="LiDAR-data minus field-based data",
         x="Years since exclosure")+
  theme_bw()+
  theme(text = element_text(size = 12))+
  #ylim(0, 0.4)+
  theme(legend.position = 'right',
                             legend.justification = c("left", "top"),
                             legend.box.just = "left",
                             #legend.margin = margin(5, 5, 5, 5),
                             legend.text = element_text(size=12))+
   geom_abline(intercept = 0, slope = 1, color="red", 
                 linetype="dashed", size=1.5)
```
It looks like older exclosures have a greater difference between LiDAR and field-based data.

I would like to see if the correlation depends on LiDAR resolution, but then we should figure out what this is about:
```{r}
table(dat2$plot_density_m2, dat2$resolution_m)
```
It's not clear which is derived from which, but I think its plot density that is the original.

```{r, echo=F}
ggplot(data = dat2,
        aes(x = plot_density_m2, y = diff))+
  geom_point()+
  geom_smooth(method = "lm")+
  labs(y="LiDAR-data minus field-based data",
         x="Plot density (points per m2)")+
  theme_bw()+
  theme(text = element_text(size = 12))+
  #ylim(0, 0.4)+
  theme(legend.position = 'right',
                             legend.justification = c("left", "top"),
                             legend.box.just = "left",
                             #legend.margin = margin(5, 5, 5, 5),
                             legend.text = element_text(size=12))+
   geom_abline(intercept = 0, slope = 1, color="red", 
                 linetype="dashed", size=1.5)
```
No big difference.

Note that we are not seeing if the slope is close to 1 or not. We assume it will be. It's correlation strength that matters.
```{r}
(field_lidar_cor <- cor(dat2$canopygrowth, dat2$canopygrowth_f, method = "pearson"))
```
And it's not very high.
We can use a more sophisticated model to see where the field-based data is better or worse at predicting LiDAR results.

```{r}
moddiff <- glmmTMB(canopygrowth~canopygrowth_f
                   +region+canopygrowth_f:region
                   +YrsSinceExclosure+YrsSinceExclosure:canopygrowth_f
                   +plot_density_m2+plot_density_m2:canopygrowth_f
                   +Treatment+Treatment:canopygrowth_f,
                   family=gaussian,
                   data=dat2)
summary(moddiff)
```
Nothing significant.
Since there are so many candidate models, we can do a shortcut and apply dredge:
```{r}
library(MuMIn)
(corr_cand <- dredge(moddiff, beta="none", rank = "AICc")[1:5,])
```
And the best model is...:
```{r}
moddiff2 <- glmmTMB(canopygrowth~canopygrowth_f
                   +YrsSinceExclosure+YrsSinceExclosure:canopygrowth_f
                   +plot_density_m2
                   +Treatment,
                   family=gaussian,
                   data=dat2)
summary(moddiff2)
```
Interpretation: Field-based data have a medium correlation to LiDAR data (0.57). The coorelation is dependent on Years since exclosure (probably this could be exchanged with tree height?) and LiDAR data is more likely to underestimate canopy growth at short experimental durations (see figure above). Similarly, lower LiDAR resolution induces underestimates in the same way. Field-based data is also not able to explain the variation induced by the fencing treatemtn. This could be a three way ineraction as well, including years since exclusion. Not sure if it should be included here actually.

Validation 
```{r}
par(mfrow=c(1,2), mar = c(4,4,1,1))
plot(resid(moddiff2), fitted(moddiff2))
qqnorm(resid(moddiff2))

```
```{r}
par(mfrow=c(3,2), mar = c(4,4,1,1))
plot(resid(moddiff2)~ dat2$region)
plot(resid(moddiff2), dat2$prod)
plot(resid(moddiff2)~ dat2$Treatment)
plot(resid(moddiff2)~ dat2$YrsSinceExclosure)
plot(resid(moddiff2)~ dat2$YrsSinceExclosure)
plot(resid(moddiff2)~ dat2$plot_density_m2)

```
Looks Ok
For the final plot I think just keep it simple.
```{r}
(corr_plot <- 
  ggplot(data = dat2,
                    aes(x = canopygrowth, y = canopygrowth_f))+
   geom_point(aes(shape = Treatment, 
                  fill = as.factor(plot_density_m2)), 
                  size=3, stroke=1)+
  labs(y=expression(paste('Field-based canopy height growth (m year'^'-1', ')')),
       x=expression(paste('LiDAR-based canopy height growth (m year'^'-1', ')')))+
  theme_bw()+
  theme(text = element_text(size = 12))+
  theme(legend.position = 'right',
                             legend.justification = c("left", "top"),
                             legend.box.just = "left",
                             #legend.margin = margin(5, 5, 5, 5),
                             legend.text = element_text(size=12))+
  scale_shape_manual(values=c(21, 24), name = "Treatment")+
  scale_fill_manual(values = c("black", "grey"), 
                    name = expression(paste(ext="Point density m"^"-2")))+
  geom_abline(intercept = 0, slope = 1, color="grey", 
                 linetype="solid", size=1.5, alpha  = 0.4)+
  guides(fill = guide_legend(override.aes=list(shape=21)))
)
```
That last line is tricky (https://github.com/tidyverse/ggplot2/issues/2322)



## Summary (final plots and tables)

### For the main manuscript:
#### methods figure from Ingrid
...

#### interaction plot for canopy growth
```{r}
cg
```

#### interaction plot for rMAD

```{r}
rmad
```

####Violin plot of max canopy height
Here we could have kept the 'outliers', but for clarity we remove them by using dat2 instead of dat.
```{r}
(viol1 <- 
   ggplot(data = dat2, aes(x = Treatment))+
  geom_violin(aes(y = md), fill = "white", alpha = 0.3)+
  geom_violin(aes(y = max), fill = "grey", alpha = 0.3)+ 
  theme_bw()+
  theme(text = element_text(size = 12))+
  labs(y='Canopy height (m)', x='')+
  stat_summary(aes(y = max), fun.y=mean, geom="point", shape=23, size=2)
)
```
Max values in grey and median values in white

##### Scatter plot LiDAR vs field data
```{r}
corr_plot
```


### Figures for the appendix:
####spagettiplot of canopy growth
```{r}
spag1
```
Two excluded sites as dotted lines

##### spagettiplot of rMAD
```{r}
spag2
```
Two excluded sites as dotted lines

##### interaction plot for canopy growth incl outlier
```{r}
cg_wOutlier
```

##### Interaction plot for rMAD incl outlier
```{r}
rmad_wOutlier
```

##### Violin plot of canopy growth
```{r}
cg_viol
```


### Tables
#### Canopy Growth
##### Mean and sd
```{r}
cg_means
```

##### Best model
```{r}
summary(mod_sens2)
```
##### Candidate models
```{r}
cg_cand
```


rMAD

```{r}
rmad_means
```
best model 
```{r}
summary(mads4)
```
candidate models
```{r}
rmad_cand
```

#### Field data
##### Mean and se
```{r}
cg_field
```

##### Correlaction
```{r}
field_lidar_cor
```
##### Global model
```{r, eval = FALSE}
canopygrowth ~ canopygrowth_f + region + canopygrowth_f:region +  
    YrsSinceExclosure + YrsSinceExclosure:canopygrowth_f + plot_density_m2 +  
    plot_density_m2:canopygrowth_f + Treatment + Treatment:canopygrowth_f
```


##### Candiate models, top 5
```{r}
corr_cand
```

##### Best model
```{r}
summary(moddiff2)
```

```{r}
AICc(moddiff2)
```



